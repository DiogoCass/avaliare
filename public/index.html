<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="author" content="Diogo Coutinho Cassemiro">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta property="og:image" content="https://i.ibb.co/cSrcKXMS/Screenshot-20251110-200654-2.jpg"/>
<meta name="description" content="üí¨ Ol√°, voc√™ est√° convidado para participar dessa pesquisa üîç">
<link rel="shortcut icon" href="https://i.ibb.co/0pPfVVQn/file-00000000b80861f784bdc1577ab98cd9-1.png" type="image/x-icon">
<link rel="apple-touch-icon" href="https://i.ibb.co/0pPfVVQn/file-00000000b80861f784bdc1577ab98cd9-1.png">
<title>Avaliare ‚Äî Sistema de Feedback Profissional</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
/* Sistema de design tokens com dark/light mode */
:root {
--bg-primary: #0f172a;
--bg-secondary: #1e293b;
--bg-card: #1e293b;
--text-primary: #f1f5f9;
--text-secondary: #94a3b8;
--text-muted: #64748b;
--border: #334155;
--accent-primary: #3b82f6;
--accent-hover: #2563eb;
--accent-light: #60a5fa;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--shadow: rgba(0,0,0,0.3);
--radius: 12px;
--transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="light"] {
--bg-primary: #ffffff;
--bg-secondary: #f8fafc;
--bg-card: #ffffff;
--text-primary: #0f172a;
--text-secondary: #475569;
--text-muted: #64748b;
--border: #e2e8f0;
--shadow: rgba(15,23,42,0.08);
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
min-height: 100vh;
-webkit-font-smoothing: antialiased;
transition: var(--transition);
}

/* Splash screen com anima√ß√£o */
#splash {
position: fixed;
inset: 0;
display: flex;
align-items: center;
justify-content: center;
background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
z-index: 100;
flex-direction: column;
gap: 16px;
}

#splash h1 {
font-size: 32px;
font-weight: 700;
color: white;
letter-spacing: -0.5px;
}

.spinner {
width: 40px;
height: 40px;
border: 3px solid rgba(255,255,255,0.2);
border-top-color: white;
border-radius: 50%;
animation: spin 0.8s linear infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* Login screen melhorado */
#loginScreen {
position: fixed;
inset: 0;
display: flex;
justify-content: center;
align-items: center;
background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
z-index: 90;
}

#loginScreen .loginBox {
background: var(--bg-card);
padding: 40px;
border-radius: 20px;
width: 92%;
max-width: 420px;
box-shadow: 0 20px 60px var(--shadow);
animation: slideUp 0.4s ease;
}

@keyframes slideUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

#loginScreen h2 {
font-size: 24px;
font-weight: 700;
margin-bottom: 8px;
color: var(--text-primary);
}

#loginScreen p {
color: var(--text-secondary);
font-size: 14px;
margin-bottom: 24px;
}

input, textarea {
width: 100%;
padding: 14px 16px;
margin-top: 12px;
border: 1.5px solid var(--border);
border-radius: var(--radius);
background: var(--bg-secondary);
color: var(--text-primary);
font-family: inherit;
font-size: 15px;
transition: var(--transition);
}

input:focus, textarea:focus {
outline: none;
border-color: var(--accent-primary);
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

textarea {
resize: vertical;
min-height: 100px;
}

.btn {
padding: 14px 20px;
border: none;
border-radius: var(--radius);
font-family: inherit;
font-size: 15px;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
}

.btn:active {
transform: translateY(1px);
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.btn-primary {
background: var(--accent-primary);
color: white;
box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover:not(:disabled) {
background: var(--accent-hover);
box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

.btn-success {
background: var(--success);
color: white;
}

.btn-danger {
background: var(--danger);
color: white;
}

.btn-secondary {
background: var(--bg-secondary);
color: var(--text-primary);
border: 1.5px solid var(--border);
}

.btn-secondary:hover {
background: var(--border);
}

/* Header com theme toggle */
header {
position: fixed;
top: 0;
left: 0;
right: 0;
height: 70px;
display: flex;
align-items: center;
justify-content: space-between;
background: var(--bg-card);
padding: 0 20px;
box-shadow: 0 2px 12px var(--shadow);
z-index: 80;
backdrop-filter: blur(10px);
}

header h1 {
font-size: 20px;
font-weight: 700;
color: var(--text-primary);
letter-spacing: -0.3px;
cursor: pointer;
user-select: none;
transition: var(--transition);
}

header h1:hover {
color: var(--accent-primary);
}

/* Adicionar estilo para mensagem de boas-vindas no header */
.welcome-message {
font-size: 14px;
color: var(--text-secondary);
font-weight: 500;
margin-left: 0px;
}

/* Badge de status unlimited */
.unlimited-badge {
display: inline-block;
background: linear-gradient(135deg, #10b981, #059669);
color: white;
font-size: 11px;
padding: 4px 10px;
border-radius: 12px;
margin-left: 10px;
font-weight: 600;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.7; }
}

.header-actions {
display: flex;
align-items: center;
gap: 12px;
}

.icon-btn {
width: 44px;
height: 44px;
display: inline-flex;
align-items: center;
justify-content: center;
border-radius: 10px;
border: none;
background: transparent;
color: var(--text-secondary);
cursor: pointer;
transition: var(--transition);
}

.icon-btn:hover {
background: var(--bg-secondary);
color: var(--text-primary);
}

/* Main content com padding ajustado */
main {
  min-height: 100vh;
}

body.quiz-public main {
  padding: 0;
}

section {
display: none;
padding: 20px;
animation: fadeIn 0.3s ease;
}

section.active {
display: block;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.container {
max-width: 1200px;
margin: 0 auto;
}

.card {
background: var(--bg-card);
border-radius: 16px;
padding: 24px;
box-shadow: 0 4px 20px var(--shadow);
border: 1px solid var(--border);
}

h2 {
font-size: 22px;
font-weight: 700;
margin-bottom: 20px;
color: var(--text-primary);
}

/* Alert box para limita√ß√µes */
.alert-box {
padding: 16px 20px;
border-radius: var(--radius);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 12px;
animation: slideUp 0.3s ease;
}

.alert-warning {
background: rgba(245, 158, 11, 0.1);
border: 1.5px solid var(--warning);
color: var(--warning);
}

.alert-danger {
background: rgba(239, 68, 68, 0.1);
border: 1.5px solid var(--danger);
color: var(--danger);
}

.alert-success {
background: rgba(16, 185, 129, 0.1);
border: 1.5px solid var(--success);
color: var(--success);
}

/* Notification Settings Card */
.notification-settings {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 20px;
margin-bottom: 20px;
}

.notification-settings h3 {
font-size: 16px;
font-weight: 600;
margin-bottom: 16px;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
}

.notification-toggle {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 16px;
}

.toggle-switch {
position: relative;
width: 50px;
height: 26px;
background: var(--border);
border-radius: 13px;
cursor: pointer;
transition: var(--transition);
}

.toggle-switch.active {
background: var(--accent-primary);
}

.toggle-switch::after {
content: '';
position: absolute;
width: 20px;
height: 20px;
border-radius: 50%;
background: white;
top: 3px;
left: 3px;
transition: var(--transition);
}

.toggle-switch.active::after {
left: 12px;
}

.notification-inputs {
display: none;
flex-direction: column;
gap: 12px;
margin-top: 16px;
}

.notification-inputs.active {
display: flex;
}

.input-group {
display: flex;
flex-direction: column;
gap: 6px;
}

.input-group label {
font-size: 13px;
color: var(--text-secondary);
font-weight: 500;
}

.frequency-selector {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.frequency-btn {
padding: 8px 16px;
border-radius: 8px;
border: 1.5px solid var(--border);
background: var(--bg-card);
color: var(--text-secondary);
font-size: 14px;
cursor: pointer;
transition: var(--transition);
}

.frequency-btn:hover {
background: var(--bg-secondary);
border-color: var(--accent-primary);
}

.frequency-btn.active {
background: var(--accent-primary);
color: white;
border-color: var(--accent-primary);
}

/* Survey cards melhoradas */
.survey-card {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 20px;
margin-bottom: 16px;
transition: var(--transition);
}

.survey-card:hover {
border-color: var(--accent-primary);
box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
transform: translateY(-2px);
}

.survey-card h3 {
font-size: 18px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 12px;
}

.survey-link {
color: var(--accent-primary);
font-size: 13px;
word-break: break-all;
display: block;
margin-bottom: 12px;
}

.survey-actions {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.btn-icon {
padding: 8px 14px;
border-radius: 8px;
border: 1.5px solid var(--border);
background: var(--bg-card);
color: var(--text-secondary);
font-size: 14px;
display: inline-flex;
align-items: center;
gap: 6px;
cursor: pointer;
transition: var(--transition);
}

.btn-icon:hover {
background: var(--bg-secondary);
color: var(--text-primary);
border-color: var(--accent-primary);
}

/* Quick options buttons para cria√ß√£o */
.quick-options {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin: 16px 0;
padding: 16px;
background: var(--bg-secondary);
border-radius: var(--radius);
border: 1.5px dashed var(--border);
}

.quick-options label {
font-size: 13px;
color: var(--text-secondary);
font-weight: 600;
width: 100%;
margin-bottom: 4px;
}

.quick-btn {
padding: 8px 12px;
border-radius: 8px;
border: 1.5px solid var(--border);
background: var(--bg-card);
color: var(--text-secondary);
font-size: 13px;
cursor: pointer;
transition: var(--transition);
}

.quick-btn:hover {
background: var(--accent-primary);
color: white;
border-color: var(--accent-primary);
}

/* Question container melhorado */
.question-container {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 20px;
margin-top: 16px;
animation: slideUp 0.3s ease;
}

.option-row {
display: flex;
gap: 8px;
margin-top: 10px;
align-items: center;
}

.option-row input {
flex: 1;
margin-top: 0;
}

.remove-btn {
width: 40px;
height: 40px;
border-radius: 8px;
border: none;
background: var(--danger);
color: white;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: var(--transition);
}

.remove-btn:hover {
background: #dc2626;
}

/* Navigation melhorada */
nav {
position: fixed;
bottom: 20px;
left: 20px;
right: 20px;
height: 70px;
background: var(--bg-card);
border-radius: 20px;
display: flex;
justify-content: space-around;
align-items: center;
box-shadow: 0 10px 40px var(--shadow);
border: 1px solid var(--border);
z-index: 80;
}

nav button {
background: none;
border: none;
color: var(--text-muted);
font-size: 28px;
padding: 12px;
border-radius: 12px;
cursor: pointer;
transition: var(--transition);
position: relative;
}

nav button.active {
color: var(--accent-primary);
}

nav button.active::after {
content: '';
position: absolute;
bottom: 1px;
left: 50%;
transform: translateX(-50%);
width: 6px;
height: 6px;
border-radius: 50%;
background: var(--accent-primary);
}

/* Quiz p√∫blico wizard com padding reduzido */
#quizPublic {
padding: 20px;
display: none;
margin-bottom: 0px;
}

#quizPublic.active {
display: flex;
}

/* Estilo para o perfil da empresa no quiz p√∫blico */
.company-profile {
background: var(--bg-card);
border-radius: 16px;
padding: 24px;
margin-bottom: 24px;
box-shadow: 0 4px 16px var(--shadow);
border: 1px solid var(--border);
display: flex;
align-items: center;
gap: 20px;
animation: slideUp 0.4s ease;
}

.company-profile-img {
width: 120px;
height: 120px;
border-radius: 50%;
object-fit: cover;
border: 3px solid var(--accent-primary);
}

.company-profile-info {
flex: 1;
}

.company-profile-name {
font-size: 20px;
font-weight: 700;
color: var(--text-primary);
margin-bottom: 8px;
}

.company-profile-description {
font-size: 14px;
color: var(--text-secondary);
line-height: 1.5;
}

.quiz-container {
max-width: 700px;
width: 100%;
margin: 0 auto;
padding: 12px;
}

.quiz-header {
text-align: center;
margin-bottom: 24px;
animation: slideUp 0.5s ease;
}

.quiz-header h2 {
font-size: 28px;
font-weight: 700;
margin-bottom: 12px;
}

.quiz-progress {
display: flex;
align-items: center;
gap: 12px;
margin-top: 20px;
}

.progress-bar {
flex: 1;
height: 8px;
background: var(--bg-secondary);
border-radius: 999px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--accent-primary), var(--accent-light));
border-radius: 999px;
transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-text {
font-size: 14px;
font-weight: 600;
color: var(--text-secondary);
white-space: nowrap;
}

.quiz-content {
background: var(--bg-card);
border-radius: 16px;
padding: 24px;
box-shadow: 0 4px 16px var(--shadow);
border: 1px solid var(--border);
animation: slideUp 0.4s ease;
}

.quiz-content h3 {
font-size: 20px;
font-weight: 600;
margin-bottom: 24px;
color: var(--text-primary);
line-height: 1.5;
}

.option-label {
display: flex;
align-items: center;
padding: 16px 20px;
margin-bottom: 12px;
background: var(--bg-secondary);
border: 2px solid var(--border);
border-radius: var(--radius);
cursor: pointer;
transition: var(--transition);
font-size: 15px;
}

.option-label:hover {
border-color: var(--accent-primary);
background: var(--bg-card);
}

.option-label input[type="radio"] {
width: 20px;
height: 20px;
margin: 0 12px 0 0;
cursor: pointer;
accent-color: var(--accent-primary);
}

.quiz-actions {
display: flex;
gap: 12px;
margin-top: 24px;
}

.quiz-actions .btn {
flex: 1;
}

/* Stats cards para dashboard */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
gap: 20px;
margin-bottom: 32px;
}

.stat-card {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 24px;
transition: var(--transition);
}

.stat-card:hover {
border-color: var(--accent-primary);
transform: translateY(-4px);
box-shadow: 0 8px 24px var(--shadow);
}

.stat-value {
font-size: 32px;
font-weight: 700;
color: var(--accent-primary);
margin: 8px 0;
}

.stat-label {
font-size: 14px;
color: var(--text-secondary);
font-weight: 500;
}

/* Adicionar estilos para barra de pesquisa e filtros */
.search-filter-container {
display: flex;
gap: 12px;
margin-bottom: 20px;
flex-wrap: wrap;
align-items: center;
}

.search-box {
flex: 1;
min-width: 250px;
position: relative;
}

.search-box input {
width: 100%;
padding-left: 44px;
margin-top: 0;
}

.search-box .material-icons-outlined {
position: absolute;
left: 14px;
top: 50%;
transform: translateY(-50%);
color: var(--text-secondary);
pointer-events: none;
}

.filter-btn {
padding: 12px 20px;
border-radius: var(--radius);
border: 1.5px solid var(--border);
background: var(--bg-secondary);
color: var(--text-secondary);
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: var(--transition);
display: inline-flex;
align-items: center;
gap: 8px;
}

.filter-btn:hover, .filter-btn.active {
background: var(--accent-primary);
color: white;
border-color: var(--accent-primary);
}

.export-btn {
padding: 12px 20px;
border-radius: var(--radius);
border: none;
background: var(--success);
color: white;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
display: inline-flex;
align-items: center;
gap: 8px;
}

.export-btn:hover {
background: #059669;
transform: translateY(-2px);
}

/* Adicionar estilos para gr√°ficos */
.chart-container {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 24px;
}

.chart-title {
font-size: 16px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 16px;
}

.bar-chart {
display: flex;
flex-direction: column;
gap: 12px;
}

.bar-item {
display: flex;
align-items: center;
gap: 12px;
}

.bar-label {
min-width: 100px;
font-size: 13px;
color: var(--text-secondary);
}

.bar-bg {
flex: 1;
height: 32px;
background: var(--bg-card);
border-radius: 6px;
overflow: hidden;
position: relative;
}

.bar-fill {
height: 100%;
background: linear-gradient(90deg, var(--accent-primary), var(--accent-light));
border-radius: 6px;
transition: width 0.6s ease;
display: flex;
align-items: center;
justify-content: flex-end;
padding-right: 8px;
}

.bar-value {
color: white;
font-size: 12px;
font-weight: 600;
}

/* Estilo para gr√°fico circular */
.chart-circular-container {
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
padding: 24px;
margin-bottom: 24px;
display: flex;
flex-direction: column;
align-items: center;
}

.chart-canvas-wrapper {
position: relative;
width: 100%;
max-width: 400px;
height: 400px;
margin: 20px auto;
}

/* Table responsiva */
.table-container {
overflow-x: auto;
margin-top: 20px;
border-radius: var(--radius);
border: 1.5px solid var(--border);
}

table {
width: 100%;
border-collapse: collapse;
}

th, td {
padding: 16px;
text-align: left;
border-bottom: 1px solid var(--border);
font-size: 14px;
}

th {
background: var(--bg-secondary);
font-weight: 600;
color: var(--text-secondary);
text-transform: uppercase;
font-size: 12px;
letter-spacing: 0.5px;
}

tr:hover {
background: var(--bg-secondary);
}

/* Modal melhorado */
.modal-overlay {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.6);
backdrop-filter: blur(4px);
display: none;
align-items: center;
justify-content: center;
z-index: 100;
animation: fadeIn 0.2s ease;
}

.modal-overlay.show {
display: flex;
}

.modal {
background: var(--bg-card);
border-radius: 16px;
padding: 32px;
max-width: 500px;
width: 92%;
box-shadow: 0 20px 60px var(--shadow);
animation: slideUp 0.3s ease;
}

.modal h3 {
font-size: 20px;
margin-bottom: 12px;
}

.modal-actions {
display: flex;
gap: 12px;
margin-top: 24px;
}

/* Word cloud */
.word-cloud {
display: flex;
flex-wrap: wrap;
gap: 12px;
padding: 24px;
background: var(--bg-secondary);
border-radius: var(--radius);
min-height: 200px;
align-items: center;
justify-content: center;
}

.word-tag {
padding: 8px 16px;
background: var(--accent-primary);
color: white;
border-radius: 8px;
font-weight: 600;
transition: var(--transition);
}

.word-tag:hover {
transform: scale(1.05);
}

/* Admin section styles */
#adminSection .admin-list {
margin-top: 20px;
}

#adminSection .client-row {
display: flex;
justify-content: space-between;
align-items: center;
padding: 16px;
background: var(--bg-secondary);
border: 1.5px solid var(--border);
border-radius: var(--radius);
margin-bottom: 12px;
}

#adminSection .client-info {
flex: 1;
}

#adminSection .client-id {
font-weight: 600;
color: var(--text-primary);
font-size: 16px;
}

#adminSection .client-stats {
font-size: 13px;
color: var(--text-secondary);
margin-top: 4px;
}

#adminSection .admin-actions {
display: flex;
gap: 8px;
}

#adminSection .btn-icon-small {
padding: 8px 12px;
font-size: 13px;
border-radius: 8px;
}

.qr-modal-content {
text-align: center;
padding: 20px;
}

.qr-modal-content h3 {
margin-bottom: 20px;
font-size: 22px;
}

.qr-code-container {
background: white;
padding: 20px;
border-radius: 12px;
display: inline-block;
margin: 20px 0;
}

.qr-modal-actions {
display: flex;
gap: 12px;
justify-content: center;
margin-top: 20px;
}

.results-filters {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-bottom: 24px;
align-items: center;
}

.results-filters .search-box {
flex: 1;
min-width: 200px;
}

.filter-buttons {
display: flex;
gap: 8px;
}

.chart-bar {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 12px;
}

.chart-label {
min-width: 150px;
font-size: 13px;
color: var(--text-secondary);
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.chart-bar-bg {
flex: 1;
height: 28px;
background: var(--bg-card);
border-radius: 6px;
overflow: hidden;
}

.chart-bar-fill {
height: 100%;
background: linear-gradient(90deg, var(--accent-primary), var(--accent-light));
border-radius: 6px;
display: flex;
align-items: center;
justify-content: flex-end;
padding-right: 10px;
transition: width 0.5s ease;
}

.chart-value {
color: white;
font-size: 12px;
font-weight: 600;
}

@media (max-width: 600px) {
.company-profile {
flex-direction: column;
text-align: center;
}
.company-profile-img {
width: 80px;
height: 80px;
}
.stats-grid {
grid-template-columns: 1fr 1fr;
}
.stat-card {
padding: 16px;
}
.stat-value {
font-size: 24px;
}
}

@import url(https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap);
.watermark{
position:fixed;
bottom:20px;
right:20px;
}
.watermarkk{
position:fixed;
bottom:20px;
left:20px;
}
.watermark-txt{
background:rgba(255,255,255,.15);
padding:8px 16px;
border-radius:20px;
font-family:Poppins,sans-serif;
font-size:14px;
color:rgba(0,0,0,.7);
display:flex;
align-items:center;
box-shadow:0 2px 10px rgba(0,0,0,.1);
border:1px solid rgba(255,255,255,.3);
position:relative;
overflow:hidden;
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash">
<h1>Avaliare</h1>
<div class="spinner"></div>
</div>

<!-- Login Screen -->
<div id="loginScreen" style="display:none">
<div class="loginBox">
<h2>Bem-vindo ao Avaliare</h2>
<p>Sistema de Feedback Profissional</p>
<input type="text" id="companyIdInput" placeholder="ID da Empresa">
<input type="password" id="passwordInput" placeholder="Senha de Acesso">
<button class="btn btn-primary" id="loginBtn" style="width:100%; margin-top:20px">
<span class="material-icons-outlined">login</span>
Entrar
</button>
</div>
<div class="watermarkk" onclick="window.location.href='https://avaliare.onrender.com/landingpage'">
   <div class="watermark-txt">
    üåü Saber Mais
   </div>
</div>
<div class="watermark" onclick="window.location.href='https://codiogo-css.droppages.com'">
   <div class="watermark-txt">
    üßë‚Äçüíª Criado por DgCass
   </div>
</div>
</div>

<!-- Header -->
<header style="display:none">
<h1>Avaliare</h1>
<div class="header-actions">
<button class="icon-btn" id="themeToggle">
<span class="material-icons-outlined">dark_mode</span>
</button>
<button class="icon-btn" id="logoutBtn">
<span class="material-icons-outlined">logout</span>
</button>
</div>
</header>

<!-- Main Content -->
<main>
<!-- Home Section -->
<section id="homeSection" class="active">
<div class="container">
<h2>Suas Pesquisas</h2>
<div class="notification-settings">
<h3><span class="material-icons-outlined">notifications</span> Notifica√ß√µes por Email</h3>
<div class="notification-toggle">
<div class="toggle-switch" id="notificationToggle"></div>
<span>Receber notifica√ß√µes de novas respostas</span>
</div>
<div class="notification-inputs" id="notificationInputs">
<div class="input-group">
<label>Email para notifica√ß√µes</label>
<input type="email" id="notificationEmail" placeholder="seu@email.com">
</div>
<div class="input-group">
<label>Frequ√™ncia (a cada X respostas)</label>
<div class="frequency-selector">
<button class="frequency-btn active" data-value="1">1</button>
<button class="frequency-btn" data-value="5">5</button>
<button class="frequency-btn" data-value="10">10</button>
<button class="frequency-btn" data-value="custom">Personalizado</button>
</div>
<div id="customFrequencyInput" style="display:none; margin-top: 8px;">
<input type="number" id="customFrequency" placeholder="Ex: 3" min="1">
</div>
</div>
<button class="btn btn-primary" id="saveNotificationBtn" style="margin-top: 12px;">
<span class="material-icons-outlined">save</span>
Salvar Configura√ß√µes
</button>
</div>
</div>
<div id="surveyList"></div>
<button class="btn btn-primary" id="newSurveyBtn" style="margin-top: 20px;">
<span class="material-icons-outlined">add</span>
Nova Pesquisa
</button>
</div>
</section>

<!-- Create Section -->
<section id="createSection">
<div class="container">
<h2>Criar Pesquisa</h2>
<input type="text" id="surveyTitle" placeholder="T√≠tulo da pesquisa">
<div id="questionsContainer"></div>
<div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
<button class="btn btn-secondary" id="addQuestionBtn">
<span class="material-icons-outlined">add</span>
Adicionar Pergunta
</button>
<button class="btn btn-success" id="saveSurveyBtn">
<span class="material-icons-outlined">save</span>
Salvar Pesquisa
</button>
</div>
</div>
</section>

<!-- Results Section -->
<section id="resultsSection">
<div class="container">
<h2>Resultados</h2>
<div id="resultsContainer"></div>
</div>
</section>

<!-- Profile Section -->
<section id="profileSection">
<div class="container">
<h2>Perfil da Empresa</h2>
<div class="card">
<div style="text-align: center; margin-bottom: 24px;">
<img id="profileAvatarPreview" src="https://via.placeholder.com/120" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-primary);">
<div style="margin-top: 12px;">
<label class="btn btn-secondary" style="cursor: pointer;">
<span class="material-icons-outlined">photo_camera</span>
Alterar Foto
<input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
</label>
</div>
</div>
<input type="text" id="profileCompanyName" placeholder="Nome da empresa">
<textarea id="profileDescription" placeholder="Descri√ß√£o da empresa (opcional)"></textarea>
<button class="btn btn-primary" id="saveProfileBtn" style="width: 100%; margin-top: 20px;">
<span class="material-icons-outlined">save</span>
Salvar Perfil
</button>
</div>
</div>
</section>

<!-- Admin Section -->
<section id="adminSection">
<div class="container">
<h2>Painel Administrativo</h2>
<div id="adminContainer"></div>
</div>
</section>
</main>

<!-- Public Quiz Section -->
<section id="quizPublic">
<div class="quiz-container"></div>
</section>

<!-- Navigation -->
<nav style="display:none">
<button id="homeNav" class="active">
<span class="material-icons-outlined">home</span>
</button>
<button id="createNav">
<span class="material-icons-outlined">add_circle</span>
</button>
<button id="resultsNav">
<span class="material-icons-outlined">bar_chart</span>
</button>
<button id="profileBtn">
<span class="material-icons-outlined">person</span>
</button>
<button id="adminNav">
<span class="material-icons-outlined">admin_panel_settings</span>
</button>
</nav>

<!-- Modal Confirma√ß√£o de Exclus√£o -->
<div class="modal-overlay" id="modalConfirm">
<div class="modal">
<h3>Confirmar Exclus√£o</h3>
<p>Tem certeza que deseja excluir esta pesquisa? Esta a√ß√£o n√£o pode ser desfeita.</p>
<div class="modal-actions">
<button class="btn btn-secondary" id="cancelDelete">Cancelar</button>
<button class="btn btn-danger" id="confirmDelete">Excluir</button>
</div>
</div>
</div>

<!-- Modal Admin -->
<div class="modal-overlay" id="modalAdmin">
<div class="modal">
<h3>Acesso Administrativo</h3>
<p>Digite a senha de administrador para continuar.</p>
<input type="password" id="adminPassword" placeholder="Senha do administrador">
<div class="modal-actions">
<button class="btn btn-secondary" id="cancelAdminAccess">Cancelar</button>
<button class="btn btn-primary" id="confirmAdminAccess">Acessar</button>
</div>
</div>
</div>

<!-- Modal Confirma√ß√£o de Exclus√£o de Usu√°rio -->
<div class="modal-overlay" id="modalConfirmUserDelete">
<div class="modal">
<h3>Confirmar Exclus√£o de Usu√°rio</h3>
<p>Tem certeza que deseja excluir este usu√°rio e TODOS os seus dados? Esta a√ß√£o n√£o pode ser desfeita.</p>
<div class="modal-actions">
<button class="btn btn-secondary" id="cancelUserDelete">Cancelar</button>
<button class="btn btn-danger" id="confirmUserDelete">Excluir Tudo</button>
</div>
</div>
</div>

<!-- Modal Upgrade -->
<div class="modal-overlay" id="upgradeModal">
<div class="modal">
<h3 style="color: var(--accent-primary);">
<span class="material-icons-outlined" style="vertical-align: middle;">rocket_launch</span>
Fa√ßa Upgrade!
</h3>
<p style="margin-top: 12px; color: var(--text-secondary);">
Para desbloquear esta funcionalidade e ter acesso ilimitado a todas as ferramentas do Avaliare, entre em contato conosco pelo WhatsApp!
</p>
<ul style="margin: 20px 0; padding-left: 20px; color: var(--text-secondary);">
<li>‚úÖ Pesquisas ilimitadas</li>
<li>‚úÖ Respostas ilimitadas</li>
<li>‚úÖ Edi√ß√£o de pesquisas</li>
<li>‚úÖ QR Code personalizado</li>
<li>‚úÖ Suporte priorit√°rio</li>
</ul>
<div class="modal-actions">
<button class="btn btn-secondary" onclick="closeUpgradeModal()">Depois</button>
<button class="btn btn-success" onclick="openWhatsApp()">
<span class="material-icons-outlined">chat</span>
Falar no WhatsApp
</button>
</div>
</div>
</div>

<!-- Modal QR Code -->
<div class="modal-overlay" id="qrModal">
<div class="modal qr-modal-content">
<h3>QR Code da Pesquisa</h3>
<div id="qrCodeContainer" class="qr-code-container"></div>
<div class="qr-modal-actions">
<button class="btn btn-secondary" id="closeQR">Fechar</button>
<button class="btn btn-primary" id="downloadQR">
<span class="material-icons-outlined">download</span>
Baixar
</button>
</div>
</div>
</div>

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
// ============================================
// CLIENTE API - Todas as chamadas v√£o para o servidor
// ============================================

// Fun√ß√£o auxiliar para fazer requisi√ß√µes ao servidor
async function api(endpoint, data = {}) {
  try {
    const response = await fetch(`/api/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Erro na requisi√ß√£o');
    return result;
  } catch (error) {
    console.error(`Erro em ${endpoint}:`, error);
    throw error;
  }
}

// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================

const themeToggle = document.getElementById('themeToggle');
const root = document.documentElement;

let currentCompany = null;
let editingSurveyId = null;
let surveyData = null;
let publicCompanyId = null;
let publicQuizId = null;
let currentStep = -1;
let userAnswers = [];
let userName = "";
let secretClickCount = 0;
let secretClickTimer = null;
let allSurveyStats = [];
let currentFilter = 'all';
let searchTerm = '';
let pieChartInstance = null;

// ============================================
// TEMA (DARK/LIGHT MODE)
// ============================================

function toggleTheme() {
  const currentTheme = root.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  root.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  themeToggle.querySelector('.material-icons-outlined').textContent = 
    newTheme === 'light' ? 'dark_mode' : 'light_mode';
}

const savedTheme = localStorage.getItem('theme') || 'dark';
root.setAttribute('data-theme', savedTheme);
themeToggle.querySelector('.material-icons-outlined').textContent = 
  savedTheme === 'light' ? 'dark_mode' : 'light_mode';
themeToggle.onclick = toggleTheme;

// ============================================
// PERFIL DA EMPRESA
// ============================================

async function getCompanyProfile(companyId) {
  try {
    return await api('getCompanyProfile', { companyId });
  } catch (err) {
    return { name: '', description: '', avatarUrl: 'https://via.placeholder.com/120' };
  }
}

async function saveCompanyProfile(companyId, profileData) {
  try {
    await api('saveCompanyProfile', { companyId, profileData });
    return true;
  } catch (err) {
    return false;
  }
}

async function loadProfileSection() {
  const profile = await getCompanyProfile(currentCompany);
  document.getElementById('profileCompanyName').value = profile.name || '';
  document.getElementById('profileDescription').value = profile.description || '';
  document.getElementById('profileAvatarPreview').src = profile.avatarUrl || 'https://via.placeholder.com/120';
}

document.getElementById('profileAvatarInput').onchange = function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profileAvatarPreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
};

document.getElementById('saveProfileBtn').onclick = async function() {
  const name = document.getElementById('profileCompanyName').value.trim();
  const description = document.getElementById('profileDescription').value.trim();
  const avatarUrl = document.getElementById('profileAvatarPreview').src;

  if (!name) {
    alert('Por favor, insira o nome da empresa');
    return;
  }

  const profileData = { name, description, avatarUrl, updatedAt: Date.now() };
  const success = await saveCompanyProfile(currentCompany, profileData);
  
  if (success) {
    alert('Perfil salvo com sucesso!');
    switchSection(document.getElementById('homeSection'));
    document.getElementById('homeNav').classList.add('active');
  } else {
    alert('Erro ao salvar perfil. Tente novamente.');
  }
};

document.getElementById('profileBtn').onclick = () => {
  switchSection(document.getElementById('profileSection'));
  loadProfileSection();
  nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
};

// ============================================
// NOTIFICA√á√ïES
// ============================================

function getNotificationSettings(companyId) {
  const key = `notificationSettings_${companyId}`;
  const stored = localStorage.getItem(key);
  return stored ? JSON.parse(stored) : { enabled: false, email: '', frequency: 1, responseCount: 0 };
}

function setNotificationSettings(companyId, settings) {
  localStorage.setItem(`notificationSettings_${companyId}`, JSON.stringify(settings));
}

async function sendEmailNotification(companyId, surveyTitle, responseCount) {
  const settings = getNotificationSettings(companyId);
  if (!settings.enabled || !settings.email) return;
  
  settings.responseCount++;
  
  if (settings.responseCount >= settings.frequency) {
    try {
      await api('sendNotification', {
        email: settings.email,
        surveyTitle,
        responseCount: settings.responseCount
      });
      settings.responseCount = 0;
    } catch (error) {
      console.error('Erro ao enviar notifica√ß√£o:', error);
    }
  }
  setNotificationSettings(companyId, settings);
}

function loadNotificationSettings() {
  if (!currentCompany) return;
  
  const settings = getNotificationSettings(currentCompany);
  const toggle = document.getElementById('notificationToggle');
  const inputs = document.getElementById('notificationInputs');
  const emailInput = document.getElementById('notificationEmail');
  const customInput = document.getElementById('customFrequencyInput');

  if (settings.enabled) {
    toggle.classList.add('active');
    inputs.classList.add('active');
  }

  if (settings.email) emailInput.value = settings.email;

  document.querySelectorAll('.frequency-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.value === settings.frequency.toString()) {
      btn.classList.add('active');
    } else if (btn.dataset.value === 'custom' && ![1, 5, 10].includes(settings.frequency)) {
      btn.classList.add('active');
      customInput.style.display = 'flex';
      document.getElementById('customFrequency').value = settings.frequency;
    }
  });
}

document.getElementById('notificationToggle').onclick = function() {
  this.classList.toggle('active');
  document.getElementById('notificationInputs').classList.toggle('active');
};

document.querySelectorAll('.frequency-btn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.frequency-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const customInput = document.getElementById('customFrequencyInput');
    customInput.style.display = this.dataset.value === 'custom' ? 'flex' : 'none';
  };
});

document.getElementById('saveNotificationBtn').onclick = function() {
  const toggle = document.getElementById('notificationToggle');
  const email = document.getElementById('notificationEmail').value.trim();
  const activeFreqBtn = document.querySelector('.frequency-btn.active');

  if (toggle.classList.contains('active') && !email) {
    alert('Por favor, insira um email v√°lido');
    return;
  }

  let frequency = activeFreqBtn.dataset.value === 'custom' 
    ? parseInt(document.getElementById('customFrequency').value) || 1 
    : parseInt(activeFreqBtn.dataset.value);

  setNotificationSettings(currentCompany, {
    enabled: toggle.classList.contains('active'),
    email,
    frequency,
    responseCount: 0
  });
  alert('Configura√ß√µes de notifica√ß√£o salvas com sucesso!');
};

// ============================================
// LIMITES DE USO
// ============================================

function getUsageLimits(companyId) {
  const key = `usageLimit_${companyId}`;
  const stored = localStorage.getItem(key);
  return stored ? JSON.parse(stored) : { surveys: 0, responses: 0, unlimited: false, hasCreatedDemo: false };
}

function setUsageLimits(companyId, limits) {
  localStorage.setItem(`usageLimit_${companyId}`, JSON.stringify(limits));
}

async function updateSurveyCount(companyId) {
  try {
    const surveys = await api('getSurveys', { companyId });
    const limits = getUsageLimits(companyId);
    limits.surveys = surveys.length;
    setUsageLimits(companyId, limits);
    return surveys.length;
  } catch (err) {
    return 0;
  }
}

async function incrementResponseCount(companyId, surveyId) {
  const limits = getUsageLimits(companyId);
  limits.responses++;
  setUsageLimits(companyId, limits);
  
  try {
    const surveyData = await api('getSurvey', { companyId, surveyId });
    if (surveyData) await sendEmailNotification(companyId, surveyData.title, limits.responses);
  } catch (err) {}
}

function toggleCompanyAccess(companyId) {
  const limits = getUsageLimits(companyId);
  limits.unlimited = !limits.unlimited;
  setUsageLimits(companyId, limits);
  updateUnlimitedBadge();
}

function unlockCompany(companyId) {
  const limits = getUsageLimits(companyId);
  limits.unlimited = true;
  setUsageLimits(companyId, limits);
  updateUnlimitedBadge();
  alert('‚ú® Acesso ilimitado ativado com sucesso!');
}

function canCreateSurvey(companyId) {
  const limits = getUsageLimits(companyId);
  return limits.unlimited || !limits.hasCreatedDemo;
}

function canReceiveResponse(companyId) {
  const limits = getUsageLimits(companyId);
  return limits.unlimited || limits.responses < 5;
}

function canEditSurvey(surveyIndex) {
  return getUsageLimits(currentCompany).unlimited;
}

function canQrSurvey(surveyIndex) {
  return getUsageLimits(currentCompany).unlimited;
}

function updateUnlimitedBadge() {
  const logo = document.querySelector('header h1');
  const existingBadge = logo.querySelector('.unlimited-badge');
  
  if (currentCompany) {
    const limits = getUsageLimits(currentCompany);
    if (limits.unlimited && !existingBadge) {
      logo.innerHTML = 'Avaliare <span class="unlimited-badge">ILIMITADO</span>';
      logo.onclick = handleSecretClick;
    } else if (!limits.unlimited && existingBadge) {
      logo.innerHTML = 'Avaliare';
      logo.onclick = handleSecretClick;
    }
  }
}

function handleSecretClick() {
  secretClickCount++;
  if (secretClickTimer) clearTimeout(secretClickTimer);
  secretClickTimer = setTimeout(() => { secretClickCount = 0; }, 2000);
  if (secretClickCount === 7) {
    secretClickCount = 0;
    unlockCompany(currentCompany);
  }
}

// ============================================
// LOGIN E NAVEGA√á√ÉO
// ============================================

const splash = document.getElementById("splash");
const loginScreen = document.getElementById("loginScreen");
const header = document.querySelector("header");
const nav = document.querySelector("nav");
const sections = document.querySelectorAll("section");
const quizPublic = document.getElementById("quizPublic");
const loginBtn = document.getElementById("loginBtn");
const companyIdInput = document.getElementById("companyIdInput");
const passwordInput = document.getElementById("passwordInput");

loginBtn.onclick = async () => {
  const comp = companyIdInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!comp || !pass) return alert("Preencha todos os campos");
  
  try {
    const result = await api('login', { companyId: comp, password: pass });
    if (!result.success) return alert("Senha incorreta");
    
    currentCompany = comp;
    sessionStorage.setItem("companyId", comp);
    loginScreen.style.display = "none";
    header.style.display = "flex";
    nav.style.display = "flex";

    const logo = document.querySelector('header h1');
    logo.onclick = handleSecretClick;
    updateUnlimitedBadge();

    switchSection(document.getElementById("homeSection"));
    await loadSurveys();
    loadNotificationSettings();
  } catch (err) {
    alert("Erro ao fazer login: " + err.message);
  }
};

function switchSection(sec) {
  sections.forEach(s => s.classList.remove("active"));
  sec.classList.add("active");
  nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
}

document.getElementById("homeNav").onclick = () => {
  switchSection(document.getElementById("homeSection"));
  document.getElementById("homeNav").classList.add('active');
};

document.getElementById("createNav").onclick = () => {
  switchSection(document.getElementById("createSection"));
  document.getElementById("createNav").classList.add('active');
};

document.getElementById("resultsNav").onclick = () => {
  switchSection(document.getElementById("resultsSection"));
  document.getElementById("resultsNav").classList.add('active');
  loadResults();
};

document.getElementById("adminNav").onclick = () => {
  switchSection(document.getElementById("adminSection"));
  document.getElementById("adminNav").classList.add('active');
  loadAdminPanel();
};

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.reload();
};

// ============================================
// CARREGAR PESQUISAS
// ============================================

async function loadSurveys() {
  const surveyList = document.getElementById("surveyList");
  await updateSurveyCount(currentCompany);
  const limits = getUsageLimits(currentCompany);

  let welcomeHTML = `
    <div class="welcome-message" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border: 1.5px solid var(--accent-primary); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
      <span class="material-icons-outlined" style="font-size: 28px; color: var(--accent-primary);">waving_hand</span>
      <div style="flex: 1;">
        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Ol√°, ${currentCompany}!</h3>
        <p style="font-size: 13px; color: var(--text-secondary);">Bem-vindo ao seu painel de pesquisas</p>
      </div>
    </div>
  `;

  surveyList.innerHTML = welcomeHTML + "<p>Carregando...</p>";

  let alertHTML = '';
  if (!limits.unlimited) {
    alertHTML = limits.hasCreatedDemo ? `
      <div class="alert-box alert-danger">
        <span class="material-icons-outlined">block</span>
        <div><strong>Teste Gratuito Encerrado!</strong> Voc√™ j√° criou sua pesquisa demo (m√°x 5 perguntas, 5 respostas). Fa√ßa upgrade para criar mais pesquisas e receber respostas ilimitadas.</div>
      </div>
    ` : `
      <div class="alert-box alert-warning">
        <span class="material-icons-outlined">info</span>
        <div><strong>Plano Gratuito:</strong> Voc√™ pode criar 1 pesquisa demonstrativa com at√© 5 perguntas e receber at√© 5 respostas. Fa√ßa upgrade para obter acesso ilimitado!</div>
      </div>
    `;
  }

  try {
    const surveys = await api('getSurveys', { companyId: currentCompany });
    surveyList.innerHTML = welcomeHTML + alertHTML;

    if (surveys.length === 0) {
      surveyList.innerHTML += "<p>Nenhuma pesquisa criada ainda</p>";
      return;
    }

    let surveyIndex = 0;
    surveys.forEach(s => {
      const div = document.createElement("div");
      div.className = "survey-card";
      
      const link = `${location.origin}${location.pathname}#quiz/${currentCompany}/${s.id}`;
      const canEdit = canEditSurvey(surveyIndex);
      const editBtnDisabled = !canEdit ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '';
      const editBtnTitle = !canEdit ? 'title="Upgrade para editar pesquisas"' : '';
      const canQr = canQrSurvey(surveyIndex);
      const qrBtnDisabled = !canQr ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '';
      const qrBtnTitle = !canQr ? 'title="Upgrade para gerar QR Code"' : '';

      div.innerHTML = `
        <h3>${s.title}</h3>
        <a class="survey-link" href="${link}" target="_blank">${link}</a>
        <div class="survey-actions">
          <button class="btn-icon copy-link-btn" data-link="${link}">
            <span class="material-icons-outlined">content_copy</span> Copiar Link
          </button>
          <button class="btn-icon del-btn" data-id="${s.id}">
            <span class="material-icons-outlined">delete</span> Excluir
          </button>
          <button class="btn-icon edit-btn" data-id="${s.id}" data-index="${surveyIndex}" ${editBtnDisabled} ${editBtnTitle}>
            <span class="material-icons-outlined">edit</span> Editar
          </button>
          <button class="btn-icon qr-btn" data-id="${s.id}" data-link="${link}" ${qrBtnDisabled} ${qrBtnTitle}>
            <span class="material-icons-outlined">qr_code_2</span> QR Code
          </button>
        </div>
      `;
      surveyList.appendChild(div);
      surveyIndex++;
    });

    document.querySelectorAll(".copy-link-btn").forEach(b => {
      b.onclick = () => {
        navigator.clipboard.writeText(b.dataset.link).then(() => {
          const originalHTML = b.innerHTML;
          b.innerHTML = '<span class="material-icons-outlined">check</span> Copiado!';
          setTimeout(() => { b.innerHTML = originalHTML; }, 2000);
        });
      };
    });

    document.querySelectorAll(".edit-btn").forEach(b => {
      b.onclick = () => {
        const index = parseInt(b.dataset.index);
        if (canEditSurvey(index)) editSurvey(b.dataset.id);
        else showUpgradeModal();
      };
    });

    document.querySelectorAll(".del-btn").forEach(b => b.onclick = () => confirmDelete(b.dataset.id));
    document.querySelectorAll(".qr-btn").forEach(b => b.onclick = () => showQRModal(b.dataset.link));
  } catch (err) {
    surveyList.innerHTML = welcomeHTML + "<p>Erro ao carregar pesquisas</p>";
  }
}

// ============================================
// CRIAR/EDITAR PESQUISA
// ============================================

const surveyTitle = document.getElementById("surveyTitle");
const questionsContainer = document.getElementById("questionsContainer");
const addQuestionBtn = document.getElementById("addQuestionBtn");
const saveSurveyBtn = document.getElementById("saveSurveyBtn");
const newSurveyBtn = document.getElementById("newSurveyBtn");

newSurveyBtn.onclick = () => {
  if (!canCreateSurvey(currentCompany)) {
    showUpgradeModal();
    return;
  }
  editingSurveyId = null;
  surveyTitle.value = "";
  questionsContainer.innerHTML = "";
  switchSection(document.getElementById("createSection"));
  document.getElementById("createNav").classList.add('active');
};

addQuestionBtn.onclick = () => addQuestion();

saveSurveyBtn.onclick = async () => {
  const limits = getUsageLimits(currentCompany);
  if (!editingSurveyId && !canCreateSurvey(currentCompany)) {
    showUpgradeModal();
    return;
  }

  const title = surveyTitle.value.trim();
  if (!title) return alert("Informe o t√≠tulo da pesquisa");

  const qBlocks = questionsContainer.querySelectorAll(".question-container");
  if (qBlocks.length === 0) return alert("Adicione pelo menos uma pergunta");
  if (!limits.unlimited && qBlocks.length > 5) {
    alert("No plano gratuito, voc√™ pode criar no m√°ximo 5 perguntas. Fa√ßa upgrade para mais!");
    return;
  }

  const questions = [];
  let hasError = false;

  qBlocks.forEach(q => {
    const text = q.querySelector(".question-text").value.trim();
    if (!text) { hasError = true; return; }
    
    const opts = [];
    q.querySelectorAll(".option-row input").forEach(o => {
      if (o.value.trim()) opts.push(o.value.trim());
    });
    
    if (opts.length < 2) {
      alert(`A pergunta "${text}" precisa ter pelo menos 2 op√ß√µes`);
      hasError = true;
      return;
    }
    questions.push({ text, options: opts });
  });

  if (hasError || questions.length === 0) return alert("Complete todas as perguntas com pelo menos 2 op√ß√µes cada");

  try {
    await api('saveSurvey', {
      companyId: currentCompany,
      surveyId: editingSurveyId,
      data: { title, created: Date.now(), questions }
    });

    if (!editingSurveyId && !limits.unlimited) {
      limits.hasCreatedDemo = true;
      setUsageLimits(currentCompany, limits);
    }

    alert("Pesquisa salva com sucesso!");
    switchSection(document.getElementById("homeSection"));
    document.getElementById("homeNav").classList.add('active');
    await loadSurveys();
  } catch (err) {
    alert("Erro ao salvar pesquisa: " + err.message);
  }
};

function addQuestion(text = "", opts = []) {
  const div = document.createElement("div");
  div.className = "question-container";

  div.innerHTML = `
    <textarea class="question-text" placeholder="Digite o texto da pergunta">${text}</textarea>
    <div class="quick-options">
      <label>Op√ß√µes R√°pidas:</label>
      <button class="quick-btn" data-type="numbers">1 a 5</button>
      <button class="quick-btn" data-type="1-10">1 a 10</button>
      <button class="quick-btn" data-type="emoji">Emo√ß√µes</button>
      <button class="quick-btn" data-type="yesno">Sim / N√£o</button>
      <button class="quick-btn" data-type="satisfaction">Satisfa√ß√£o</button>
      <button class="quick-btn" data-type="frequency">Frequ√™ncia</button>
      <button class="quick-btn" data-type="agreement">Concord√¢ncia</button>
    </div>
    <div class="options-list"></div>
    <center>
      <button class="btn btn-secondary add-option-btn" style="margin-top: 12px;">
        <span class="material-icons-outlined">add</span> Adicionar Op√ß√£o
      </button>
      <button class="btn btn-danger" style="margin-top: 8px;" onclick="this.closest('.question-container').remove()">
        <span class="material-icons-outlined">delete</span> Deletar Pergunta
      </button>
    </center>
  `;

  const optionsList = div.querySelector(".options-list");

  div.querySelectorAll(".quick-btn").forEach(btn => {
    btn.onclick = () => {
      optionsList.innerHTML = "";
      const type = btn.dataset.type;
      let options = [];
      
      if (type === "numbers") options = ["1", "2", "3", "4", "5"];
      else if (type === "1-10") options = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
      else if (type === "yesno") options = ["Sim", "N√£o"];
      else if (type === "satisfaction") options = ["Muito Insatisfeito", "Insatisfeito", "Neutro", "Satisfeito", "Muito Satisfeito"];
      else if (type === "frequency") options = ["Nunca", "Raramente", "√Äs vezes", "Frequentemente", "Sempre"];
      else if (type === "agreement") options = ["Discordo Totalmente", "Discordo", "Neutro", "Concordo", "Concordo Totalmente"];
      else if (type === "emoji") options = ["ü§©", "üòÉ", "üôÇ", "üòê", "üôÅ"];
      
      options.forEach(opt => addOption(optionsList, opt));
    };
  });

  div.querySelector(".add-option-btn").onclick = () => addOption(optionsList);
  questionsContainer.appendChild(div);
  if (opts.length > 0) opts.forEach(o => addOption(optionsList, o));
}

function addOption(container, value = "") {
  const row = document.createElement("div");
  row.className = "option-row";
  row.innerHTML = `
    <input type="text" value="${value}" placeholder="Digite uma op√ß√£o">
    <button class="remove-btn"><span class="material-icons-outlined">close</span></button>
  `;
  row.querySelector(".remove-btn").onclick = () => row.remove();
  container.appendChild(row);
}

async function editSurvey(id) {
  try {
    const s = await api('getSurvey', { companyId: currentCompany, surveyId: id });
    if (!s) return alert("Pesquisa n√£o encontrada");

    editingSurveyId = id;
    surveyTitle.value = s.title;
    questionsContainer.innerHTML = "";
    s.questions.forEach(q => addQuestion(q.text, q.options));

    switchSection(document.getElementById("createSection"));
    document.getElementById("createNav").classList.add('active');
  } catch (err) {
    alert("Erro ao carregar pesquisa");
  }
}

async function confirmDelete(id) {
  const modal = document.getElementById("modalConfirm");
  modal.classList.add("show");

  document.getElementById("confirmDelete").onclick = async () => {
    try {
      await api('deleteSurvey', { companyId: currentCompany, surveyId: id });
      modal.classList.remove("show");

      const limits = getUsageLimits(currentCompany);
      if (!limits.unlimited) {
        const count = await updateSurveyCount(currentCompany);
        if (count === 0) {
          limits.hasCreatedDemo = true;
          limits.responses = 0;
          setUsageLimits(currentCompany, limits);
        }
      }
      await loadSurveys();
    } catch (err) {
      alert("Erro ao excluir pesquisa");
      modal.classList.remove("show");
    }
  };

  document.getElementById("cancelDelete").onclick = () => modal.classList.remove("show");
}

// ============================================
// QUIZ P√öBLICO
// ============================================

function hasRespondedToSurvey(surveyId) {
  return localStorage.getItem(`responded_${surveyId}`) === 'true';
}

function markSurveyAsResponded(surveyId) {
  localStorage.setItem(`responded_${surveyId}`, 'true');
}

window.addEventListener("hashchange", handleHash);

async function handleHash() {
  const hash = location.hash;
  if (!hash.startsWith("#quiz/")) return;

  const parts = hash.split("/");
  if (parts.length < 3) return;

  publicCompanyId = parts[1];
  publicQuizId = parts[2];

  splash.style.display = "none";
  loginScreen.style.display = "none";
  header.style.display = "none";
  nav.style.display = "none";
  switchSection(quizPublic);

  await loadPublicQuiz();
}

async function loadPublicQuiz() {
  const container = document.querySelector(".quiz-container");
  
  try {
    const d = await api('getSurvey', { companyId: publicCompanyId, surveyId: publicQuizId });

    if (!d) {
      container.innerHTML = "<p style='text-align:center;color:var(--text-secondary)'>Pesquisa n√£o encontrada</p>";
      return;
    }

    if (hasRespondedToSurvey(publicQuizId)) {
      container.innerHTML = `
        <div class="quiz-content" style="text-align: center;">
          <span class="material-icons-outlined" style="font-size: 64px; color: var(--warning);">check_circle</span>
          <h3 style="margin-top: 20px;">Voc√™ j√° respondeu esta pesquisa</h3>
          <p style="color: var(--text-secondary); margin-top: 12px;">Obrigado por sua participa√ß√£o! Voc√™ j√° enviou suas respostas para esta pesquisa anteriormente.</p>
        </div>
      `;
      return;
    }

    if (!canReceiveResponse(publicCompanyId)) {
      container.innerHTML = `
        <div class="quiz-content" style="text-align: center;">
          <span class="material-icons-outlined" style="font-size: 64px; color: var(--danger);">block</span>
          <h3 style="margin-top: 20px;">Teste Gratuito Encerrado</h3>
          <p style="color: var(--text-secondary); margin-top: 12px;">Esta pesquisa atingiu o limite de 5 respostas do plano gratuito. Entre em contato com o administrador para obter o plano completo.</p>
        </div>
      `;
      return;
    }

    surveyData = d;
    currentStep = -1;
    userAnswers = [];
    renderQuizStep();
  } catch (e) {
    container.innerHTML = "<p style='text-align:center;color:var(--text-secondary)'>Erro ao carregar pesquisa</p>";
  }
}

async function renderQuizStep() {
  const container = document.querySelector(".quiz-container");
  const totalSteps = surveyData.questions.length + 2;
  const currentProgress = ((currentStep + 2) / totalSteps) * 100;
  
  const companyProfile = await getCompanyProfile(publicCompanyId);
  
  let companyProfileHTML = '';
  if (companyProfile && companyProfile.name) {
    companyProfileHTML = `
      <div style="flex-direction: row;" class="company-profile">
        <img src="${companyProfile.avatarUrl || 'https://via.placeholder.com/80'}" alt="${companyProfile.name}" class="company-profile-img">
        <div class="company-profile-info">
          <div class="company-profile-name">${companyProfile.name}</div>
          <div class="company-profile-description">${companyProfile.description || ''}</div>
        </div>
      </div>
    `;
  }

  let headerHTML = `
    ${companyProfileHTML}
    <div class="quiz-header">
      <h2>${surveyData.title}</h2>
      <div class="quiz-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${currentProgress}%"></div>
        </div>
        <span class="progress-text">${Math.round(currentProgress)}%</span>
      </div>
    </div>
  `;

  if (currentStep === -1) {
    container.innerHTML = headerHTML + `
      <div class="quiz-content">
        <h3>Bem-vindo! Antes de come√ßar, nos diga seu nome:</h3>
        <input type="text" id="inputName" placeholder="Seu nome completo">
        <div class="quiz-actions">
          <button class="btn btn-primary" id="startBtn">Come√ßar <span class="material-icons-outlined">arrow_forward</span></button>
        </div>
      </div>
    `;

    document.getElementById("startBtn").onclick = () => {
      const name = document.getElementById("inputName").value.trim();
      if (!name) return alert("Por favor, digite seu nome");
      userName = name;
      currentStep = 0;
      renderQuizStep();
    };
    return;
  }

  if (currentStep < surveyData.questions.length) {
    const q = surveyData.questions[currentStep];
    let optionsHTML = "";

    if (q.options && q.options.length > 0) {
      q.options.forEach(opt => {
        optionsHTML += `<label class="option-label"><input type="radio" name="q${currentStep}" value="${opt}"><span>${opt}</span></label>`;
      });
    } else {
      optionsHTML = `<input type="text" id="openAnswer" placeholder="Digite sua resposta">`;
    }

    container.innerHTML = headerHTML + `
      <div class="quiz-content">
        <h3>Quest√£o ${currentStep + 1} de ${surveyData.questions.length}</h3>
        <h3 style="margin-top:12px; white-space: wrap;">${q.text}</h3>
        <div style="margin-top: 24px">${optionsHTML}</div>
        <div class="quiz-actions">
          <button class="btn btn-secondary" id="prevBtn"><span class="material-icons-outlined">arrow_back</span> Anterior</button>
          <button class="btn btn-primary" id="nextBtn">Pr√≥ximo <span class="material-icons-outlined">arrow_forward</span></button>
        </div>
      </div>
    `;

    document.getElementById("prevBtn").onclick = () => {
      currentStep = currentStep > 0 ? currentStep - 1 : -1;
      renderQuizStep();
    };

    document.getElementById("nextBtn").onclick = () => {
      let answer = "";
      const selected = document.querySelector(`input[name='q${currentStep}']:checked`);
      const openAnswer = document.getElementById("openAnswer");
      
      if (selected) answer = selected.value;
      else if (openAnswer) answer = openAnswer.value.trim();
      
      if (!answer) return alert("Por favor, responda a quest√£o");
      
      userAnswers[currentStep] = { question: q.text, answer };
      currentStep++;
      renderQuizStep();
    };
    return;
  }

  container.innerHTML = headerHTML + `
    <div class="quiz-content">
      <h3>Obrigado, ${userName}!</h3>
      <p style="color: var(--text-secondary); margin-top: 8px;">Gostaria de deixar algum coment√°rio adicional? (Opcional)</p>
      <textarea id="commentBox" placeholder="Seu coment√°rio (opcional)"></textarea>
      <div class="quiz-actions">
        <button class="btn btn-success" id="submitBtn"><span class="material-icons-outlined">send</span> Enviar Respostas</button>
      </div>
    </div>
  `;

  document.getElementById("submitBtn").onclick = async () => {
    const comment = document.getElementById("commentBox").value.trim();

    try {
      await api('submitResponse', {
        companyId: publicCompanyId,
        surveyId: publicQuizId,
        data: { name: userName, answers: userAnswers, comment, timestamp: Date.now() }
      });

      await incrementResponseCount(publicCompanyId, publicQuizId);
      markSurveyAsResponded(publicQuizId);

      container.innerHTML = `
        <div class="quiz-content" style="text-align: center;">
          <span class="material-icons-outlined" style="font-size: 64px; color: var(--success);">check_circle</span>
          <h3 style="margin-top: 20px;">Respostas enviadas com sucesso!</h3>
          <p style="color: var(--text-secondary); margin-top: 12px;">Obrigado por participar, ${userName}. Sua opini√£o √© muito importante para n√≥s!</p>
        </div>
      `;
    } catch (err) {
      alert("Erro ao enviar. Tente novamente.");
    }
  };
}

// ============================================
// RESULTADOS
// ============================================

function exportToCSV() {
  if (allSurveyStats.length === 0) {
    alert('Nenhum dado para exportar');
    return;
  }

  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Pesquisa,Respondente,Data,";
  
  const maxQuestions = Math.max(...allSurveyStats.map(s => s.responses.length > 0 ? s.responses[0].answers.length : 0));
  for (let i = 1; i <= maxQuestions; i++) csvContent += `Pergunta ${i},Resposta ${i},`;
  csvContent += "Coment√°rio\n";

  allSurveyStats.forEach(survey => {
    survey.responses.forEach(response => {
      let row = `"${survey.title}","${response.name}","${new Date(response.timestamp).toLocaleDateString('pt-BR')}",`;
      response.answers.forEach(answer => { row += `"${answer.question}","${answer.answer}",`; });
      row += `"${response.comment || ''}"\n`;
      csvContent += row;
    });
  });

  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download", `relatorio_avaliare_${Date.now()}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function applyFilters() { renderFilteredResults(); }

function renderFilteredResults() {
  let filteredStats = [...allSurveyStats];

  if (currentFilter === 'recent') {
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    filteredStats = filteredStats.map(survey => ({
      ...survey,
      responses: survey.responses.filter(r => r.timestamp >= sevenDaysAgo)
    })).filter(survey => survey.responses.length > 0);
  }

  if (searchTerm) {
    filteredStats = filteredStats.filter(survey => 
      survey.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      survey.responses.some(r => 
        r.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        r.comment?.toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }

  updateResultsDisplay(filteredStats);
}

function updateResultsDisplay(surveyStats) {
  const resultsContainer = document.getElementById("resultsContainer");
  let totalResponses = 0;
  let allComments = [];
  const responseCounts = {};

  surveyStats.forEach(survey => {
    totalResponses += survey.responses.length;
    survey.responses.forEach(r => { if (r.comment) allComments.push(r.comment); });
    responseCounts[survey.title] = survey.responses.length;
  });

  const wordFreq = {};
  const stopWords = ['a', 'o', 'e', 'de', 'da', 'do', 'em', 'um', 'uma', 'os', 'as', 'dos', 'das', 'para', 'com', 'por', 'que', 'no', 'na', 'nos', 'nas'];

  allComments.forEach(comment => {
    comment.toLowerCase().split(/\s+/).forEach(word => {
      word = word.replace(/[^a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±]/g, '');
      if (word.length > 3 && !stopWords.includes(word)) wordFreq[word] = (wordFreq[word] || 0) + 1;
    });
  });

  const topWords = Object.entries(wordFreq).sort((a, b) => b[1] - a[1]).slice(0, 20);
  const maxResponses = Math.max(...Object.values(responseCounts), 1);

  let html = `
    <div class="results-filters">
      <div class="search-box">
        <span class="material-icons-outlined">search</span>
        <input type="text" id="searchInput" placeholder="Buscar por pesquisa, respondente ou coment√°rio..." value="${searchTerm}">
      </div>
      <div class="filter-buttons">
        <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">Todas</button>
        <button class="filter-btn ${currentFilter === 'recent' ? 'active' : ''}" data-filter="recent">Recentes (7 dias)</button>
      </div>
      <button class="export-btn" onclick="exportToCSV()"><span class="material-icons-outlined">download</span> CSV</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Total de Respostas</div><div class="stat-value">${totalResponses}</div></div>
      <div class="stat-card"><div class="stat-label">Pesquisas Ativas</div><div class="stat-value">${surveyStats.length}</div></div>
      <div class="stat-card"><div class="stat-label">Coment√°rios</div><div class="stat-value">${allComments.length}</div></div>
      <div class="stat-card"><div class="stat-label">Taxa de Engajamento</div><div class="stat-value">${totalResponses > 0 ? Math.round((allComments.length / totalResponses) * 100) : 0}%</div></div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Respostas por Pesquisa</div>
      ${Object.entries(responseCounts).map(([title, count]) => `
        <div class="chart-bar">
          <div class="chart-label" title="${title}">${title}</div>
          <div class="chart-bar-bg">
            <div class="chart-bar-fill" style="width: ${(count / maxResponses) * 100}%"><span class="chart-value">${count}</span></div>
          </div>
        </div>
      `).join('')}
    </div>

    <div class="chart-circular-container">
      <div class="chart-title">Distribui√ß√£o de Respostas por Pesquisa</div>
      <div class="chart-canvas-wrapper"><canvas id="pieChart"></canvas></div>
    </div>

    <h3 style="margin-top: 32px; margin-bottom: 16px;">Palavras Mais Frequentes</h3>
    <div class="word-cloud">
      ${topWords.length > 0 ? topWords.map(([word, count]) => 
        `<span class="word-tag" style="font-size: ${12 + Math.min(count * 2, 20)}px">${word} (${count})</span>`
      ).join('') : '<p style="color: var(--text-secondary)">Sem coment√°rios ainda</p>'}
    </div>
  `;

  surveyStats.forEach(survey => {
    if (survey.responses.length === 0) return;
    html += `
      <h3 style="margin-top: 32px; margin-bottom: 16px;">${survey.title}</h3>
      <div class="table-container">
        <table>
          <thead><tr><th>Respondente</th><th>Data</th>${survey.responses[0].answers.map((_, i) => `<th>Q${i + 1}</th>`).join('')}<th>Coment√°rio</th></tr></thead>
          <tbody>
            ${survey.responses.map(r => `
              <tr>
                <td><strong>${r.name}</strong></td>
                <td>${new Date(r.timestamp).toLocaleDateString('pt-BR')}</td>
                ${r.answers.map(a => `<td>${a.answer}</td>`).join('')}
                <td>${r.comment || '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  });

  resultsContainer.innerHTML = html;

  setTimeout(() => {
    const ctx = document.getElementById('pieChart');
    if (ctx) {
      if (pieChartInstance) pieChartInstance.destroy();
      
      const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#6366f1'];

      pieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(responseCounts),
          datasets: [{
            data: Object.values(responseCounts),
            backgroundColor: colors.slice(0, Object.keys(responseCounts).length),
            borderWidth: 2,
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card').trim()
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                padding: 15,
                font: { size: 12, family: 'Inter' }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: ${context.parsed} respostas (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
  }, 100);

  document.getElementById('searchInput').oninput = (e) => { searchTerm = e.target.value; applyFilters(); };
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.onclick = () => { currentFilter = btn.dataset.filter; applyFilters(); };
  });
}

async function loadResults() {
  const resultsContainer = document.getElementById("resultsContainer");
  resultsContainer.innerHTML = "<p>Carregando resultados...</p>";
  if (!currentCompany) return;

  try {
    const surveys = await api('getSurveys', { companyId: currentCompany });
    if (surveys.length === 0) {
      resultsContainer.innerHTML = "<p>Nenhuma pesquisa para exibir</p>";
      return;
    }

    allSurveyStats = [];
    for (const survey of surveys) {
      const responses = await api('getResponses', { companyId: currentCompany, surveyId: survey.id });
      allSurveyStats.push({ title: survey.title, id: survey.id, responses, count: responses.length });
    }
    renderFilteredResults();
  } catch (err) {
    resultsContainer.innerHTML = "<p>Erro ao carregar resultados</p>";
  }
}

// ============================================
// ADMIN PANEL
// ============================================

async function deleteUserCompletely(companyId) {
  try {
    await api('deleteUser', { companyId });
    
    const keysToDelete = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.includes(companyId)) keysToDelete.push(key);
    }
    keysToDelete.forEach(key => localStorage.removeItem(key));
    return true;
  } catch (error) {
    return false;
  }
}

async function loadAdminPanel() {
  const adminContainer = document.getElementById("adminContainer");
  adminContainer.innerHTML = `
    <div class="alert-box alert-warning">
      <span class="material-icons-outlined">admin_panel_settings</span>
      <div><strong>Painel de Administra√ß√£o:</strong> Gerencie os limites de uso dos clientes.</div>
    </div>
    <p>Carregando clientes...</p>
  `;

  const clients = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('usageLimit_')) {
      const companyId = key.replace('usageLimit_', '');
      const limits = JSON.parse(localStorage.getItem(key));
      clients.push({ companyId, limits });
    }
  }

  if (clients.length === 0) {
    adminContainer.innerHTML += '<p style="color: var(--text-secondary)">Nenhum cliente registrado ainda</p>';
    return;
  }

  let clientsHTML = '<div class="admin-list">';
  clients.forEach(client => {
    const statusBadge = client.limits.unlimited ? '<span class="unlimited-badge">ILIMITADO</span>' : '<span style="color: var(--warning)">BASICO</span>';
    const toggleIcon = client.limits.unlimited ? 'lock' : 'lock_open';
    const toggleText = client.limits.unlimited ? 'Blo' : 'Des';
    const toggleClass = client.limits.unlimited ? 'btn-danger' : 'btn-success';

    clientsHTML += `
      <div class="client-row">
        <div class="client-info">
          <div class="client-id">${client.companyId} ${statusBadge}</div>
          <div class="client-stats">Pes: ${client.limits.surveys} | Res: ${client.limits.responses}</div>
        </div>
        <div class="admin-actions">
          <button class="btn-icon btn-icon-small ${toggleClass} toggle-access-btn" data-company="${client.companyId}">
            <span class="material-icons-outlined">${toggleIcon}</span> ${toggleText}
          </button>
          <button class="btn-icon btn-icon-small btn-danger remove-user-btn" data-company="${client.companyId}">
            <span class="material-icons-outlined">delete_forever</span> DEL
          </button>
        </div>
      </div>
    `;
  });
  clientsHTML += '</div>';

  adminContainer.innerHTML = adminContainer.innerHTML.replace('<p>Carregando clientes...</p>', clientsHTML);

  document.querySelectorAll('.toggle-access-btn').forEach(btn => {
    btn.onclick = () => {
      const companyId = btn.dataset.company;
      const limits = getUsageLimits(companyId);
      const action = limits.unlimited ? 'bloquear' : 'desbloquear';
      if (confirm(`Deseja ${action} o acesso para ${companyId}?`)) {
        toggleCompanyAccess(companyId);
        loadAdminPanel();
      }
    };
  });

  document.querySelectorAll('.remove-user-btn').forEach(btn => {
    btn.onclick = () => {
      const companyId = btn.dataset.company;
      const modal = document.getElementById('modalConfirmUserDelete');
      modal.classList.add('show');
      
      document.getElementById('confirmUserDelete').onclick = async () => {
        modal.classList.remove('show');
        adminContainer.innerHTML = '<p>Removendo usu√°rio e todos os dados...</p>';
        
        const success = await deleteUserCompletely(companyId);
        if (success) {
          alert(`Usu√°rio ${companyId} removido com sucesso!`);
          loadAdminPanel();
        } else {
          alert('Erro ao remover usu√°rio. Verifique o console para mais detalhes.');
          loadAdminPanel();
        }
      };
      
      document.getElementById('cancelUserDelete').onclick = () => modal.classList.remove('show');
    };
  });
}

// ============================================
// MODAIS
// ============================================

function showUpgradeModal() { document.getElementById('upgradeModal').classList.add('show'); }
function closeUpgradeModal() { document.getElementById('upgradeModal').classList.remove('show'); }

function openWhatsApp() {
  const phone = '5551996748252';
  const message = encodeURIComponent('Ol√°! Gostaria de fazer upgrade para o plano ilimitado do Avaliare. Poderia me passar mais informa√ß√µes?');
  window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
}

function showQRModal(link) {
  const modal = document.getElementById('qrModal');
  const container = document.getElementById('qrCodeContainer');
  container.innerHTML = '';
  new QRCode(container, { text: link, width: 256, height: 256, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
  modal.classList.add('show');
}

document.getElementById('downloadQR').onclick = function() {
  const canvas = document.querySelector('#qrCodeContainer canvas');
  if (canvas) {
    const link = document.createElement('a');
    link.download = 'qrcode-pesquisa.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }
};

document.getElementById('closeQR').onclick = function() { document.getElementById('qrModal').classList.remove('show'); };

// ============================================
// INICIALIZA√á√ÉO
// ============================================

setTimeout(() => {
  splash.style.display = "none";
  const saved = sessionStorage.getItem("companyId");

  if (saved) {
    currentCompany = saved;
    header.style.display = "flex";
    nav.style.display = "flex";
    updateUnlimitedBadge();
    document.querySelector('header h1').onclick = handleSecretClick;
    switchSection(document.getElementById("homeSection"));
    loadSurveys().then(() => loadNotificationSettings());
  } else {
    loginScreen.style.display = "flex";
  }

  if (location.hash.startsWith("#quiz/")) handleHash();
}, 1500);

window.onload = () => {
  const adminNav = document.getElementById('adminNav');
  const modalAdmin = document.getElementById('modalAdmin');
  const adminPassword = document.getElementById('adminPassword');
  const confirmAdminAccess = document.getElementById('confirmAdminAccess');
  const cancelAdminAccess = document.getElementById('cancelAdminAccess');
  let isAdminAuthenticated = false;

  adminNav.onclick = async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (isAdminAuthenticated) {
      switchSection(document.getElementById("adminSection"));
      document.getElementById("adminNav").classList.add('active');
      loadAdminPanel();
    } else {
      modalAdmin.classList.add('show');
      adminPassword.value = '';
      adminPassword.focus();
    }
  };

  confirmAdminAccess.onclick = async () => {
    const pass = adminPassword.value;
    try {
      const result = await api('verifyAdmin', { password: pass });
      if (result.success) {
        isAdminAuthenticated = true;
        modalAdmin.classList.remove('show');
        switchSection(document.getElementById("adminSection"));
        document.getElementById("adminNav").classList.add('active');
        loadAdminPanel();
      } else {
        alert('Senha incorreta');
        adminPassword.value = '';
      }
    } catch (err) {
      alert('Erro ao verificar senha');
    }
  };

  cancelAdminAccess.onclick = () => { modalAdmin.classList.remove('show'); adminPassword.value = ''; };
  adminPassword.onkeypress = (e) => { if (e.key === 'Enter') confirmAdminAccess.click(); };
};

window.openWhatsApp = openWhatsApp;
window.closeUpgradeModal = closeUpgradeModal;
window.exportToCSV = exportToCSV;
</script>
</body>
</html>
